<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title></title>
    <style type="text/css">
        html, body {
            background-color: #232220;
            color: #dad6d0;
        }
    </style>
</head>
<body>

    <canvas id="can-black"></canvas>
    <canvas id="can-red"></canvas>
    <canvas id="can-white"></canvas>

    <!-- Fullscreen canvas and drawhex -->
    <script type="text/javascript">
        function fullscreenCanvas(id) {
            var c = window.document.getElementById(id);
            var ctx = c.getContext('2d');

            ctx.canvas.width = window.innerWidth;
            ctx.canvas.height = window.innerHeight;
            ctx.canvas.style.position = 'absolute';
            ctx.canvas.style.top = 0;
            ctx.canvas.style.left = 0;

            return ctx;
        }

        function translateCenter(ctx) {
            ctx.translate((ctx.canvas.width / 2) | 0, (ctx.canvas.height / 2) | 0);
            return ctx;
        }

        var ctxRed = translateCenter(fullscreenCanvas('can-red'));
        var ctxBlack = translateCenter(fullscreenCanvas('can-black'));
        var ctxWhite = translateCenter(fullscreenCanvas('can-white'));

    </script>

    <!-- imagedata -->
    <script type="text/javascript">

        function imageData() {

            var width = 0;
            var height = 0;

            for (var i = 0; i < arguments.length; i += 2) {

                var skip = arguments[i];
                var draw = arguments[i + 1];

                width++;
                height = Math.max(height, skip + draw);
            }

            var sf = 1;//scalefactor

            var ctx = document.createElement('canvas').getContext('2d');
            ctx.canvas.width = width * sf;
            ctx.canvas.height = height * sf;

            var data = ctx.createImageData(ctx.canvas.width, ctx.canvas.height);

            var col = 0;

            for (var i = 0; i < arguments.length; i += 2) {

                var skip = arguments[i];
                var draw = arguments[i + 1];

                for (var j = 0; j < draw; ++j)
                    for (var xi = 0; xi < sf; ++xi)
                        for (var xj = 0; xj < sf; ++xj) {

                            var prow = (j + skip) * sf + xj;
                            var pcol = col * sf + xi;
                            var pos = (prow * ctx.canvas.width + pcol) * 4;

                            data.data[pos + 0] = 255;
                            data.data[pos + 1] = 255;
                            data.data[pos + 2] = 255;
                            data.data[pos + 3] = 255;
                        }

                ++col;

            }

            ctx.putImageData(data, 0, 0);


            return ctx;
        }

        function imageDataMirrorred() {

            var args = new Array(arguments.length * 2);

            for (var i = 0; i < arguments.length; i += 2) {
                args[i] = args[arguments.length * 2 - i - 2] = arguments[i];
                args[i + 1] = args[arguments.length * 2 - i - 1] = arguments[i + 1];
            }

            return imageData.apply(null, args);
        }

        function imageDataRev() {
            var args = new Array(arguments.length);

            for (var i = 0; i < arguments.length; i += 2) {
                args[i] = arguments[arguments.length - i - 2];
                args[i + 1] = arguments[arguments.length - i - 1];
            }

            return imageData.apply(null, args);
        }

        function flipArgs() {
            var args = new Array(arguments.length);

            var width = 0;
            var height = 0;

            for (var i = 0; i < arguments.length; i += 2) {

                var skip = arguments[i];
                var draw = arguments[i + 1];

                height = Math.max(height, skip + draw);
            }

            var args = new Array(arguments.length);

            for (var i = 0; i < arguments.length; i += 2) {

                var skip = arguments[i];
                var draw = arguments[i + 1];

                args[i] = height - (skip + draw);
                args[i + 1] = draw;
            }

            return args;
        }

        function imageDataFlip() {
            var flipped = flipArgs.apply(null, arguments);

            return imageData.apply(null, flipped);
        }

        function imageDataFlipRev() {
            var flipped = flipArgs.apply(null, arguments);

            return imageDataRev.apply(null, flipped);
        }

    </script>

    <script type="text/javascript">

        /* Hexoid: origin at x
        dimentions: distance between y=const, w; distance between x=const, h;
                    distance from origin to bottom tip, tx;
                    distance from origin to top-left tip, ty
              o
           o     o
        o           o
        o           o
        x           o
           o     o  .
              o     .
                 .  .
                    .
        */
        function Hexoid(i, j, w, h, tx, ty) {
            this.i = i;
            this.j = j;
            this.w = w;
            this.h = h;

            if (arguments.length == 4) {
                tx = Math.ceil(w / 2);
                ty = Math.ceil(h / 2);
            }

            this.tx = tx;
            this.ty = ty;
        }

        Hexoid.prototype.contains = function (i, j) {
            var dy = i - this.i;
            var dx = j - this.j;

            return dy >= 0 && dx >= 0 && dy < this.h && dx < this.w && dy - dx < this.ty && dx - dy < this.tx;
        }

        function Cell(logical, physical) {
            this.logical = logical;
            this.physical = physical;
        }

        function makemap(mapheight, mapwidth, makecell) {
            var map = [];
            for (var i = 0; i < mapheight; ++i) {
                var row = [];
                for (var j = 0; j < mapwidth; ++j) row.push(makecell(i, j));
                map.push(row);

            }
            return map;
        }

        function getAdj(map, i, j) {

            var dirsdeltas = [
                [/*down-right*/ 1, 0],
                [/*up-right*/ 1, 1],
                [/*up*/ 0, 1],
                [/*up-left*/ -1, 0],
                [/*down-left*/ -1, -1],
                [/*down*/ 0, -1]
            ];

            var n = map.length;
            var m = map[n - 1].length;

            return dirsdeltas.map(function (d, dir) {
                var dx = d[0];
                var dy = d[1];

                var id = i + dy;
                var jd = j + dx;

                return (id >= 0 && jd >= 0 && id < n && jd < m) ? map[id][jd] : null;
            });
        }

        var sockDist = 7;
        var sockSize = 5;
        var sockWidth = 7;

        var size = sockWidth * sockDist + 2;

        var sf = 1;
        var sizex = sf * 14;
        var sizey = sf * 16;

        var sockhexoid = new Hexoid(0, 0, sockWidth, sockWidth);
        var maphexoid = new Hexoid(0, 0, size, size);

        function makemaphexoid(hexoid) {
            var s = (size / 2) | 0;

            var o = (sockWidth / 2) | 0;
            var z = (sockSize / 2) | 0;

            var i = s + sockDist * (hexoid.i - o) - z;
            var j = s + sockDist * (hexoid.j - o) - z;

            var w = sockSize + hexoid.w * sockDist;
            var h = sockSize + hexoid.h * sockDist;

            var tx = z + 1 + hexoid.tx * sockDist;
            var ty = z + 1 + hexoid.ty * sockDist;

            return new Hexoid(i, j, w, h, tx, ty);
        }

        var cells = makemap(sockWidth, sockWidth, function (i, j) {
            return sockhexoid.contains(i, j)
            ? new Cell(new Hexoid(i, j, 0, 0), makemaphexoid(new Hexoid(i, j, 0, 0)))
                : null;
        });

        // todo: validate coordinates and cells compatibility
        function merge(i1, j1, i2, j2) {
            
            var dx = j2 - j1;
            var dy = i2 - i1;

            var h1 = cells[i1][j1].logical;
            var h2 = cells[i2][j2].logical;

            var w = h2.w + dx;
            var h = h2.h + dy;

            var tx = h1.tx + 1 - dy;
            var ty = h1.ty + 1 - dx;

            var hexoid = new Hexoid(i1, j1, w, h, tx, ty);

            console.log(dx, dy);
            console.log(h1.w, h1.h, h1.tx, h1.ty)
            console.log(h2.w, h2.h, h2.tx, h2.ty)
            console.log(i1, j1, w, h, tx, ty);

            cells[i1][j1] = new Cell(hexoid, makemaphexoid(hexoid));
            cells[i2][j2] = null;
        }


        merge(1, 1, 2, 1);
        merge(3, 3, 3, 4);

        merge(4, 4, 4, 5);
        merge(4, 4, 5, 5);

        
        merge(3, 2, 4, 2);
        merge(3, 2, 4, 3);

        merge(1, 3, 2, 4);

        function makecell(i, j) {
            if (maphexoid.contains(i, j)) {
                for (var k = 0; k < cells.length; ++k)
                    for (var l = 0; l < cells[k].length; ++l)
                        if (cells[k][l] != null && cells[k][l].physical.contains(i, j))
                            return 3;

                return Math.floor(Math.random() * 2) + 1;
            }

            return 0;
        }

        var time = (new Date()).getTime();
        var map = makemap(size, size, makecell);
        console.log('Done creating in ' + ((new Date()).getTime() - time) + 'ms');

        // "bitmaps"
        var core = imageDataMirrorred(4, 8, 3, 10, 3, 10, 2, 12, 1, 14, 1, 14, 0, 16);
        var corners = [
            [16, 5, imageData(0, 6, 2, 2)],
            [10, 0, imageData(0, 1, 0, 1, 0, 2, 0, 3, 1, 2, 3, 1)],
            [2, 0, imageDataRev(0, 1, 0, 1, 0, 2, 0, 3, 1, 2, 3, 1)],
            [0, 5, imageDataRev(0, 6, 2, 2)],
            [2, 12, imageDataFlipRev(0, 1, 0, 1, 0, 2, 0, 3, 1, 2, 3, 1)],
            [10, 12, imageDataFlip(0, 1, 0, 1, 0, 2, 0, 3, 1, 2, 3, 1)]
        ];

        function renderCore(ctx, x, y) {
            ctx.drawImage(core.canvas, x + 2 * sf, y);
            return;
        }

        function renderCorner(ctx, x, y, c) {
            var corner = corners[c]
            ctx.drawImage(corner[2].canvas, x + corner[0] * sf, y + corner[1] * sf);
        }

        function colorize(ctx, color) {

            ctx.save();

            ctx.globalCompositeOperation = 'source-atop';
            ctx.fillStyle = color;
            ctx.fillRect(-ctx.canvas.width / 2, -ctx.canvas.height / 2, ctx.canvas.width, ctx.canvas.height);

            ctx.restore();
        }

        function render() {

            var time = (new Date()).getTime();

            var layers = [];

            layers[2] = ctxBlack;
            layers[1] = ctxRed;
            layers[3] = ctxWhite;

            var cols = size;
            var rows = size;

            for (var i = -1; i <= map.length; ++i) {
                for (var j = -1; j <= map[0].length; ++j) {


                    var valid = (i >= 0 && j >= 0 && i < map.length && j < map[i].length);
                    var ctx = valid ? layers[map[i][j]] : null;

                    var x = j * sizex - (sizex * cols / 2) | 0;
                    var y = -(i - rows / 2) + (j - cols / 2) / 2;

                    y = (y * sizey) | 0;

                    var adj = getAdj(map, i, j);

                    if (valid && ctx) {
                        renderCore(ctx, x, y);
                    }
                    for (var d = 0; d < 6; ++d) {
                        if (ctx && valid && (adj[d] == map[i][j] || adj[(d + 1) % 6] == map[i][j]))
                            renderCorner(ctx, x, y, d);
                        else if ((!valid || adj[d] != map[i][j]) && adj[d] == adj[(d + 1) % 6] && layers[adj[d]]) {
                            var other = layers[adj[d]];

                            if (other)
                                renderCorner(other, x, y, d);
                        }
                        else if (ctx && (layers[adj[d]] || layers[adj[(d + 1) % 6]])) {
                            renderCorner(ctx, x, y, d);
                        }
                    }
                }
            }

            colorize(ctxBlack, '#24282a');
            colorize(ctxRed, '#2a3236');
            colorize(ctxWhite, 'silver');

            console.log('render completed in ' + ((new Date()).getTime() - time) + 'ms');
        }

        render();

    </script>
</body>
</html>
