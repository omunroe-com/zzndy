<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
    <link rel="stylesheet" href="style/pixelless.css" type="text/css"/>
    <title>Progress</title>
    <style type="text/css">
	    .progress-frame	{
		    border: .1em solid #eee;
		    padding: .1em;
	    }

	    .progress-bar	{
		    margin-top: .1em;
		    background-color: #eee;
		    height: 2em;
	    }
    </style>
</head>
<body>
<div id="container">
    <div class="content header">
        <h1>Progress</h1>
    </div>
    <div class="content">
	    <div class="progress-frame">
		    <div id="pb1" class="progress-bar"></div>
	    </div>
	    <a href="#reset" onclick="return reset(event)">Start</a>

        <div class="empty_footer">
        </div>
    </div>
</div>
<div id="footer">
    <div class="content">
        &copy; 2008-2010 Vynogradov
    </div>
</div>
<script type="text/javascript">
//<![CDATA[
function ProgressMeter(view)
{
	this._scale = 1;
	this._progress = 0;

	this._views = [view];
}

ProgressMeter.prototype.reset = function()
{
	this._progress = 0;
	this.refresh();
}

ProgressMeter.prototype.progress = function(pct)
{
	if(!this.done() && pct > 0)
	{
		this._progress  = Math.min(100, this._progress + pct);
		var p = this._progress;
		this.refresh();
	}
}

ProgressMeter.prototype.done = function()
{
	return this._progress >= 100;
}

ProgressMeter.prototype.refresh = function()
{
	var vs = this._views;
	var p = this._progress;
	window.setTimeout(function(){vs.forEach(function(v){v.update(p)})}, 1);
}

function BarView(elt)
{
	this.elt = elt;
}

BarView.prototype.update = function(pct)
{
	this.elt.style.width = pct + '%';
}

var bar = document.getElementById('pb1');
var barView = new BarView(bar);

var progress = new ProgressMeter(barView);

function report()
{
	var max = 1000;
	var i = 0;
	progress.reset();

	function rep()	{
		if(i++<max)
		{
			progress.progress(100 / max);
			window.setTimeout(rep, 1);
		}
	}

	rep();
}

function reset(e)
{
	try
	{
		e.target.innerHTML = 'Restart';
	}
	catch(e){}

	try
	{
		window.setTimeout(report, 1);
	}
	catch(e){}

	return false;
}
//]]>
</script>
</body>
</html>
