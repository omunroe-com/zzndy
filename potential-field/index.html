<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
    <title>Potential Field</title>
    <link rel="stylesheet" type="text/css" href="../style/common.css"/>
    <style type="text/css">
        canvas {
            border: 1px solid;
        }
    </style>
    <script type="text/javascript" src="../script/util.js"></script>
    <script type="text/javascript" src="../script/canvas.js"></script>

    <script type="text/javascript" src="script/vector.js"></script>
</head>
<body>
<br/>

<div id="target"></div>
<script type="text/javascript">
    var deg = Math.PI / 180;
    var canvas = document.createElement('canvas');
    canvas.setAttribute('width', '800px');
    canvas.setAttribute('height', '500px');
    var ctx = canvas.getContext('2d');
    ctx.strokeStyle = '#c4c0ba';
    ctx.fillStyle = '#c4c0ba';
    document.getElementById('target').appendChild(canvas);

    var field = [], n = 50, m = 80, i = -1;
    var dx = 800 / m, dy = 500 / n;

    function Goal(point, radius, spread)
    {
        this.point = point;
        this.r = radius;
        this.s = spread;
    }

    Goal.prototype.getVector = function(point, max)
    {
        var dx = this.point.x - point.x, dy = this.point.y - point.y;
        var d = Math.sqrt(dx * dx + dy * dy);

        var ang = Math.atan2(dy, dx), a = max / this.s;

        var v;
        if (d <= this.r)
            v = new Vector(0, 0);
        else if (d >= this.s)
            v = new Vector(a * this.s * Math.cos(ang), a * this.s * Math.sin(ang));
        else
            v = new Vector(a * (d - this.r) * Math.cos(ang), a * (d - this.r) * Math.sin(ang));

        if (d <= this.r) a = 0;

        return v;
    };

    Goal.prototype.draw = function(ctx)
    {
        ctx
                .fillCircle(this.point.x, this.point.y, this.r)
                //.strokeCircle(this.point.x, this.point.y, this.s);
    }

    function Obstacle(point, radius, spread)
    {
        this.point = point;
        this.r = radius;
        this.s = spread;
    }
    Obstacle.prototype = new Goal;
    Obstacle.prototype.getVector = function (point, max)
    {
        var dx = this.point.x - point.x, dy = this.point.y - point.y;
        var d = Math.sqrt(dx * dx + dy * dy);

        var ang = Math.atan2(dy, dx), a = - max / this.s;

        var v;
        if (d <= this.r)
            v = new Vector(a * this.s * Math.cos(ang), a * this.s * Math.sin(ang));
        else if (d >= this.s)
            v = new Vector(0, 0);
        else
            v = new Vector(a * (this.s + this.r - d) * Math.cos(ang), a * (this.s + this.r - d) * Math.sin(ang));

        if (d <= this.r) a = 0;

        return v;
    }

    ctx.translate(dx/2, dy/2);
    var goal = new Goal(new Point(300, 300), 25, 150);
    var obst0 = new Obstacle(new Point(600, 140), 15, 100);
    var obst1 = new Obstacle(new Point(100, 90), 13, 75);
    var obst2 = new Obstacle(new Point(570, 320), 18, 125);

    while (++i < n)
    {
        field[i] = [];
        var j = -1;
        while (++j < m)
        {
            var point = new Point(j * dx, i * dy)
            field[i][j] = new Force(
                    point,
                    goal.getVector(point, dx/2)
                            .add(obst0.getVector(point, dx/1.5))
                            .add(obst1.getVector(point, dx/1.5))
                            .add(obst2.getVector(point, dx/1.5))
                    );
        }
    }

    goal.draw(ctx);
    obst0.draw(ctx);
    obst1.draw(ctx);
    obst2.draw(ctx);
    i = -1;
    while (++i < n)
    {
        var j = -1;
        while (++j < m)
        {
            draw_force(ctx, field[i][j]);
        }
    }

    function draw_force(ctx, force)
    {
        ctx.save()
                .translate(force.point.x, a1 = force.point.y)
                .fillCircle(0, 0, 1.5)
                .beginPath()
                .moveTo(0, 0)
                .lineTo(force.vector.x, a1 = force.vector.y)
                .closePath()
                .stroke()
                .restore();
    }

</script>
</body>
</html>
