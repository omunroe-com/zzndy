<!DOCTYPE html>
<html lang="en">
<head>
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
    <link rel="stylesheet" href="../style/pixelless.css" type="text/css"/>
    <script type="text/javascript" src="../script/util.js"></script>
    <script type="text/javascript" src="../script/canvas.js"></script>
    <script type="text/javascript" src="script/vector.js"></script>
    <script type="text/javascript" src="script/pf.js"></script>
    <title>Potential field</title>
    <style type="text/css">
        canvas {
            border: 1px solid;
            cursor: none;
        }
    </style>
</head>
<body>
<div id="container">
    <div class="content header">
        <h1>Potential field</h1>
    </div>

    <div class="content">
        <div id="target"></div>
        <div class="empty_footer">
        </div>
    </div>
</div>
<div id="footer">
    <div class="content">
        &copy; Copyright
    </div>
</div>
<script type="text/javascript">
    // init
    function makeCanvas(w, h, at)
    {
        var canvas = document.createElement('canvas');
        canvas.setAttribute('width', w + 'px');
        canvas.setAttribute('height', h + 'px');
        canvas.setAttribute('id', at);
        canvas.appendChild(document.createTextNode('Canvas is not supported in this browser.'));

        var target = document.getElementById(at);
        target.parentNode.replaceChild(canvas, target);

        return canvas.getContext('2d').translate(-.5, h - .5).scale(1, -1);
    }

    function mouseToCanvas(e)
    {
        var x = 0,y = 0;

        if (!e)
        {
            e = window.event;
            x = e.offsetX;
            y = e.offsetY;
        }
        else // we assume DOM modeled javascript
        {
            var elt = e.target ;
            var left = 0;
            var top = 0 ;

            while (elt.offsetParent)
            {
                left += elt.offsetLeft;
                top += elt.offsetTop;
                elt = elt.offsetParent;
            }

            x = e.pageX - left;
            y = e.pageY - top;
        }

        mouse = new Point(x, height - y);
    }

    function putPointer()
    {
        ctx
            .clearRect(0, 0, width, height)
            .beginPath()
            .moveTo(mouse.x, mouse.y - 5)
            .lineTo(mouse.x, mouse.y + 5)
            .stroke()
            .beginPath()
            .moveTo(mouse.x - 5, mouse.y)
            .lineTo(mouse.x + 5, mouse.y)
            .stroke();

        prev = mouse;


        field = new PotentialField(n, m);
        field.apply(mouseCharge, (mouse.x - sx / 2) / sx, (mouse.y - sy / 2) / sy);
        field = base.add(field);


        obj.vel = obj.vel.add(field.getForce(obj.pos.x, obj.pos.y)).div(2);
        obj.pos.x += obj.vel.x;
        obj.pos.y += obj.vel.y;

        renderField();
    }

    var mouse = new Point(5.5, 6.6);
    var prev = mouse;

    var width = 800;
    var height = 500;
    var ctx = makeCanvas(width, height, 'target');
    ctx.fillStyle = ctx.strokeStyle = '#D7D7D7';


    var mul = 3;
    var m = 8 * mul, n = 5 * mul;
    var sx = width / m, sy = height / n;

    var base = new PotentialField(n, m);
    var field;
    var mouseCharge = new Charge(-.3, 5);
    var vwall = new Wall(0, n, .5, 2);
    var hwall = new Wall(m, 0, .5, 2);
    var bar = new Wall(m/2,0, .5,2);

    base.apply(vwall, -.01, 0);
    base.apply(vwall, m-.99 , 0);
    base.apply(hwall, 0, -.01);
    base.apply(hwall, 0, n-.99);

    var obj = {
        pos:new Point(m / 2, n / 2),
        vel:new Vector(0, 0)
    };

    function renderField()
    {
        if (!(field instanceof PotentialField)) return;

        ctx.save().translate(sx / 2, sy / 2);
        var i = -1, n = field.rows;
        while (++i < n)
        {
            var j = -1, m = field.cols;
            while (++j < m)
            {
                var f = field.getForce(j, i);

                ctx
                    .save()
                    .translate(j * sx, i * sy)
                    .strokeCircle(0, 0, 1)
                    .beginPath()
                    .moveTo(0, 0)
                    .lineTo(f.x * sx, f.y * sy)
                    .stroke()
                    .restore();
            }
        }

        ctx
            .save()
            .translate(obj.pos.x * sx, obj.pos.y * sy)
            .rotate(obj.vel.angle)
            .fillRect(-2.5, -2.5, 5, 5)
            .beginPath()
            .moveTo(0, 0)
            .lineTo(obj.vel.abs * sx * 2, 0)
            .stroke()
            .restore();

        ctx.restore();
    }

    window.setInterval(putPointer, 40);
    document.getElementById('target').onmousemove = mouseToCanvas;

</script>
</body>
</html>
