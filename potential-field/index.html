<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
    <link rel="stylesheet" href="../style/pixelless.css" type="text/css"/>
    <script type="text/javascript" src="../script/util.js"></script>
    <script type="text/javascript" src="../script/canvas.js"></script>
    <script type="text/javascript" src="script/vector.js"></script>
    <script type="text/javascript" src="script/pf.js"></script>
    <title>Potential field</title>
    <style type="text/css">
        canvas {
            border: 1px solid;
        }
    </style>
</head>
<body>
<div id="container">
    <div class="content header">
        <h1>Potential field</h1>
    </div>

    <div class="content">
        <canvas id="target" width="800px" height="500px">Convas is not supported in this browser.</canvas>
        <div class="emtpy_footer">
        </div>
    </div>
</div>
<div id="footer">
    <div class="content">
        &copy; Copyright
    </div>
</div>
<script type="text/javascript" language="JavaScript">
    var ctx = document.getElementById('target').getContext('2d');
    ctx.strokeStyle = '#D7D7D7';
    ctx.fillStyle = '#D7D7D7';

    var n = 25, m = 40;
    var dx = 800 / m, dy = 500 / n;
    ctx.translate(dx / 2, dy / 2);
    function drawField( ctx, fld )
    {
        var i = -1;
        while( ++i < fld.rows )
        {
            var j = -1;
            while( ++j < fld.cols )
            {
                ctx.fillCircle(j * dx, i * dy, 1.5)
                        .moveTo(j * dx, i * dy)
                        .lineTo((j + fld.body[i][j].x ) * dx, (i + fld.body[i][j].y) * dy)
                        .stroke();
            }
        }
    }

    var base = new PotentialField(n, m);
    var mouse = new Charge(19.3, 10.8, -.9);
    var wall0 = new Wall(0, 20, 40, 0, 2, 10);

    base.apply(wall0);

    var fld = new PotentialField(n, m);
    fld.apply(mouse);
    fld = fld.add(base);

    drawField(ctx, fld);

    function getPos( e )
    {
        return new Point(e.clientX - e.target.offsetLeft, e.clientY - e.target.offsetTop);
    }

    function mousemove( e )
    {
        var pos = getPos(e);

        var fld = new PotentialField(n, m);

        mouse.x = (pos.x - dx / 2) / dx;
        mouse.y = (pos.y - dy / 2) / dy;

        fld.apply(mouse);
        fld = fld.add(base);

        ctx.clearRect(-dx / 2, -dy / 2, 800, 500);
        drawField(ctx, fld);
        ctx.moveTo(wall0.x1 * dx, wall0.y1 * dy)
                .lineTo(wall0.x2 * dx, wall0.y2 * dy)
                .stroke();
    }

    document.getElementById('target').onmousemove = mousemove;

</script>
</body>
</html>
