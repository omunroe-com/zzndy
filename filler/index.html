<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
    <link rel="stylesheet" href="../style/pixelless.css" type="text/css"/>
    <title>Filler</title>
    <script type="text/javascript" src="../script/util.js"></script>
    <script type="text/javascript" src="../script/canvas.js"></script>
    <script type="text/javascript" src="../script/color.js"></script>
    <script type="text/javascript" src="script/logic.js"></script>
    <script type="text/javascript" src="script/presentation.js"></script>
    <style type="text/css">
        html, body {
            background-color: #262626;
        }

        #colors {
            font-size: 170%;
            float: left;
            width: 3.5em;
        }

        .color-control {
            text-decoration: none;
            height: 2.2em;
            width: 2em;
            display: inline-block;
            padding-left: .2em;
            color: #484848;
            font-family: Tahoma, sans-serif;
            border: .15em solid;
            margin: .3em;
            border-radius: .4em;
            -moz-border-radius: .4em;
        }

        #player, #computer {
            font-size: 170%;
            color: white;
            font-weight: bold;
        }

        #player {
            float: left;
        }

        #computer {
            float: right;
        }

    </style>
</head>
<body>
<div id="container">
    <div class="content header">
        <h1>Filler</h1>
    </div>

    <div class="content">
        <div id="colors"></div>
        <div style="float:left;width:800px">
            <canvas id="main-filler-canvas" width="800px" height="500px"></canvas>
            <div id="player"></div>
            <div id="computer"></div>
        </div>

        <div class="emtpy_footer">
        </div>
    </div>
</div>
<div id="footer">
    <div class="content">
        &copy; Vynogradov 2009
    </div>
</div>
<script type="text/javascript">
    var canvasId = 'main-filler-canvas';
    var canvas = document.getElementById(canvasId);

    var filler = new Filler(canvas);
    filler.render();

    var control_holder = document.getElementById('colors');
    var colors = filler.getColors();

    var controlTmp = '<a href="#color{n}" id="color-{n}" class="color-control color-{n}" onclick="setColor({n})">{sn}</a>';
    var styleTmp
            = '.color-{n} {background-color: {color}; border-color: {light1} {dark1} {dark2} {light2}; color: {text-color}}\n\n'
            + '.color-{n}:hover, .color-{n}:visited, .color-{n}:visited:hover {color: {text-color}}\n\n'
            + '.color-{n}:hover, .color-{n}:visited:hover {background-color: {light2}}\n'
            + '.color-{n}.disabled:hover, .color-{n}.disabled:visited, .color-{n}.disabled:hover:visited {background-color:transparent;color:#888;border-color:#888 } ';


    function generateControl( colorStr, n )
    {
        return controlTmp.fmt({n:n, sn:n + 1 });
    }

    function generateStyle( colorStr, n )
    {
        var color = new Color(colorStr);
        var textColor = ((color.red + color.green + color.blue) / 3 + 128) % 256 < 128 ? '#262626' : '#e0e0e0';
        return styleTmp.fmt({n:n , color:color.tint(-20), light1:color.tint(80), light2:color.tint(30), dark1:color.tint(-55), dark2:color.tint(-90),'text-color':textColor});
    }


    var style = document.createElement('style');
    style.setAttribute('type', 'text/css');
    style.appendChild(document.createTextNode( colors.map(generateStyle).join('\n\n')));

    document.getElementsByTagName('head')[0].appendChild(style);

    control_holder.innerHTML = colors.map(generateControl).join('');

    function disableButton( i )
    {
        var button = document.getElementById('color-' + i);
        button.className += ' disabled';
    }

    function enableButton( i )
    {
        var button = document.getElementById('color-' + i);
        button.className = button.className.replace(/\bdisabled\b/, '');
    }

    disableButton(filler.p1color);
    disableButton(filler.p2color);

    function setColor( n )
    {
        var control = document.getElementById('color-' + n);
        if ( !control.className.match(/disabled/) ) {
            enableButton(filler.p1color);
            enableButton(filler.p2color);

            filler.setColor(n);
            filler.moveP2();

            disableButton(filler.p1color);
            disableButton(filler.p2color);

            var a = filler.logic.p1share;
            var b = filler.logic.p2share;

            document.getElementById('player').innerHTML = a.toFixed(2) + '%';
            document.getElementById('computer').innerHTML = b.toFixed(2) + '%';

            if ( a > 50 )gamover('You win!');
            if ( b > 50 )gamover('You lose.');
        }
    }

    function gamover( message )
    {
        range(7).forEach(disableButton);
        if ( message.match(/win/) )
            document.getElementById('player').innerHTML += ' ' + message;
        else
            document.getElementById('computer').innerHTML = message + ' ' + document.getElementById('computer').innerHTML;
    }

    window.onkeypress = function( e )
    {
        if ( e.charCode >= 49 && e.charCode <= 55 )
            setColor(e.charCode - 49);
    }


</script>
</body>
</html>
