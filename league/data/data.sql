-- MYSQL version 5 or greater required

DROP TABLE IF EXISTS Matches;
DROP TABLE IF EXISTS Games;
DROP TABLE IF EXISTS Players;

CREATE TABLE IF NOT EXISTS Players (
	player_id INT UNSIGNED AUTO_INCREMENT NOT NULL,
	name VARCHAR(128) NOT NULL,
	rating DECIMAL(5,2),
	createdOn  TIMESTAMP NOT NULL DEFAULT '0000-00-00 00:00:00.000',
	modifiedOn TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
	PRIMARY KEY pk_player_id (player_id),
	INDEX ix_player_name (name)
)
AUTO_INCREMENT 1000, ENGINE=INNODB;

CREATE TRIGGER t_PlayersCreatedOn 
BEFORE INSERT 
ON Players 
FOR EACH ROW
	SET NEW.createdOn = CURRENT_TIMESTAMP;

CREATE TABLE IF NOT EXISTS Games	(
	game_id INT UNSIGNED AUTO_INCREMENT NOT NULL,
	player_one_id INT UNSIGNED REFERENCES Players (player_id) ON UPDATE CASCADE,
	player_two_id INT UNSIGNED REFERENCES Players (player_id) ON UPDATE CASCADE,
	scheduledOn TIMESTAMP NOT NULL DEFAULT '0000-00-00 00:00:00.000',
	createdOn   TIMESTAMP NOT NULL DEFAULT '0000-00-00 00:00:00.000',
	modifiedOn  TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
	PRIMARY KEY pk_game_id (game_id)
)
AUTO_INCREMENT 1000, ENGINE=INNODB;

CREATE TRIGGER t_GamesCreatedOn 
BEFORE INSERT 
ON Games 
FOR EACH ROW
	SET NEW.createdOn = CURRENT_TIMESTAMP;

CREATE TABLE Matches	(
	match_id INT UNSIGNED AUTO_INCREMENT NOT NULL,
	game_id INT UNSIGNED REFERENCES Games (game_id) ON UPDATE CASCADE,
	first_serves BIT DEFAULT 1 COMMENT 'True if first player is doing first serving',
	player_one_score TINYINT UNSIGNED DEFAULT 0,
	player_two_score TINYINT UNSIGNED DEFAULT 0,
	createdOn   TIMESTAMP NOT NULL DEFAULT '0000-00-00 00:00:00.000',
	modifiedOn  TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
	PRIMARY KEY pk_match_id (match_id)
) 
AUTO_INCREMENT 1000, ENGINE=INNODB;

CREATE TRIGGER t_MatchesCreatedOn 
BEFORE INSERT 
ON Matches 
FOR EACH ROW
	SET NEW.createdOn = CURRENT_TIMESTAMP;
